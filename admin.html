<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Ashcol Airconditioning Corporation</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Admin dashboard for managing service requests and customer queue.">
    <meta name="keywords" content="admin dashboard, queue management, service management">
    <meta name="author" content="Ashcol Airconditioning Corporation">
    
    <!-- Favicon -->
    <link rel="icon" type="image/jpeg" href="ash.JPG">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 2rem;
        }
        
        .admin-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .admin-header h1 {
            color: #39B54A;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        
        .admin-header p {
            color: #666;
            font-size: 1.1rem;
        }
        
        .admin-tabs {
            display: flex;
            background: white;
            border-radius: 12px 12px 0 0;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            margin-bottom: 0;
        }
        
        .tab-button {
            flex: 1;
            padding: 1rem;
            border: none;
            background: #f8f9fa;
            color: #666;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 12px 12px 0 0;
        }
        
        .tab-button.active {
            background: #39B54A;
            color: white;
        }
        
        .tab-button:hover {
            background: #2d8f3a;
            color: white;
        }
        
        .tab-content {
            display: none;
            background: white;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            padding: 2rem;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 4px solid #39B54A;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #39B54A;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: #666;
            font-weight: 500;
        }
        
        .admin-controls {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .control-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
            margin-bottom: 1rem;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
        }
        
        .control-group label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }
        
        .control-group select,
        .control-group input {
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            border-color: #39B54A;
        }
        
        .admin-table {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .table-header {
            background: #39B54A;
            color: white;
            padding: 1rem;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr 1fr auto;
            gap: 1rem;
            font-weight: 600;
        }
        
        .table-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr 1fr auto;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid #e1e5e9;
            align-items: center;
        }
        
        .table-row:hover {
            background: #f8f9fa;
        }
        
        .table-row:last-child {
            border-bottom: none;
        }
        
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            text-align: center;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-in-progress {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .status-completed {
            background: #d4edda;
            color: #155724;
        }
        
        .status-emergency {
            background: #f8d7da;
            color: #721c24;
        }
        
        .ticket-number {
            font-weight: 700;
            color: #39B54A;
        }
        
        .customer-name {
            font-weight: 600;
        }
        
        .service-type {
            color: #666;
        }
        
        .date-time {
            font-size: 0.875rem;
            color: #666;
        }
        
        .urgency-high {
            color: #dc3545;
            font-weight: 600;
        }
        
        .urgency-emergency {
            color: #dc3545;
            font-weight: 700;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .btn-small {
            padding: 0.25rem 0.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: background-color 0.3s ease;
        }
        
        .btn-view {
            background: #17a2b8;
            color: white;
        }
        
        .btn-view:hover {
            background: #138496;
        }
        
        .btn-progress {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-progress:hover {
            background: #e0a800;
        }
        
        .btn-complete {
            background: #28a745;
            color: white;
        }
        
        .btn-complete:hover {
            background: #218838;
        }
        
        .btn-branch {
            background: #6f42c1;
            color: white;
        }
        
        .btn-branch:hover {
            background: #5a32a3;
        }
        
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        
        .btn-delete:hover {
            background: #c82333;
        }
        
        .no-tickets {
            text-align: center;
            padding: 3rem;
            color: #666;
        }
        
        .no-tickets i {
            font-size: 4rem;
            color: #e1e5e9;
            margin-bottom: 1rem;
        }
        
        .refresh-btn {
            background: #39B54A;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background-color 0.3s ease;
        }
        
        .refresh-btn:hover {
            background: #2d8f3a;
        }
        
        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .auto-refresh input[type="checkbox"] {
            margin: 0;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e1e5e9;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        .ticket-details {
            display: grid;
            gap: 1rem;
        }
        
        .detail-row {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 1rem;
            align-items: center;
        }
        
        .detail-label {
            font-weight: 600;
            color: #333;
        }
        
        .detail-value {
            color: #666;
        }
        
        .branch-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .branch-modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
        }
        
        .branch-form {
            display: grid;
            gap: 1rem;
        }
        
        .branch-form select {
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .branch-form select:focus {
            outline: none;
            border-color: #39B54A;
        }
        
        .branch-form textarea {
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            resize: vertical;
            min-height: 100px;
        }
        
        .branch-form textarea:focus {
            outline: none;
            border-color: #39B54A;
        }
        
        .branch-buttons {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1rem;
        }
        
        .btn-cancel {
            background: #6c757d;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease;
        }
        
        .btn-cancel:hover {
            background: #5a6268;
        }
        
        .btn-save {
            background: #39B54A;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease;
        }
        
        .btn-save:hover {
            background: #2d8f3a;
        }
        
        @media (max-width: 768px) {
            .table-header,
            .table-row {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .table-header {
                display: none;
            }
            
            .table-row {
                border: 1px solid #e1e5e9;
                border-radius: 8px;
                margin-bottom: 1rem;
                padding: 1rem;
            }
            
            .admin-container {
                margin: 1rem;
                padding: 1rem;
            }
            
            .detail-row {
                grid-template-columns: 1fr;
            }
            
            .admin-tabs {
                flex-direction: column;
            }
            
            .tab-button {
                border-radius: 0;
            }
            
            .tab-button:first-child {
                border-radius: 12px 12px 0 0;
            }
            
            .tab-button:last-child {
                border-radius: 0 0 12px 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <img src="ash.JPG" alt="Ashcol Airconditioning Corporation Logo" class="logo-img">
                <span class="logo-text">Ashcol Airconditioning</span>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="AshcolHome.html" class="nav-link">Home</a>
                </li>
                <li class="nav-item">
                    <a href="queue.html" class="nav-link">Queue</a>
                </li>
                <li class="nav-item">
                    <a href="request.html" class="nav-link">Request Service</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" id="logoutBtn">Logout</a>
                </li>
            </ul>
            <div class="hamburger">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </div>
    </nav>

    <div class="admin-container">
        <div class="admin-header">
            <h1><i class="fas fa-cogs"></i> Admin Dashboard</h1>
            <p>Manage service requests and customer records</p>
            <div style="margin-top: 1rem;">
                <a href="admin.html" style="background: #39B54A; color: white; padding: 0.5rem 1rem; text-decoration: none; border-radius: 8px; margin-right: 0.5rem;">
                    <i class="fas fa-ticket-alt"></i> Ticket Management
                </a>
                <a href="admin_integrated.html" style="background: #17a2b8; color: white; padding: 0.5rem 1rem; text-decoration: none; border-radius: 8px;">
                    <i class="fas fa-building"></i> Integrated Admin (Branch Records)
                </a>
            </div>
        </div>

        <div class="admin-tabs">
            <button class="tab-button active" onclick="showTab('tickets')">
                <i class="fas fa-ticket-alt"></i> Active Tickets
            </button>
            <button class="tab-button" onclick="showTab('records')">
                <i class="fas fa-users"></i> Branch Records
            </button>
        </div>

        <!-- Active Tickets Tab -->
        <div id="ticketsTab" class="tab-content active">
            <div class="admin-stats" id="adminStats">
                <!-- Stats will be populated by JavaScript -->
            </div>

            <div class="admin-controls">
                <div class="control-row">
                    <div class="control-group">
                        <label for="statusFilter">Filter by Status</label>
                        <select id="statusFilter">
                            <option value="">All Status</option>
                            <option value="Pending">Pending</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="serviceFilter">Filter by Service Type</label>
                        <select id="serviceFilter">
                            <option value="">All Services</option>
                            <option value="Installation">Installation</option>
                            <option value="Repair">Repair</option>
                            <option value="Maintenance">Maintenance</option>
                            <option value="Cleaning">Cleaning</option>
                            <option value="Emergency">Emergency</option>
                            <option value="Inspection">Inspection</option>
                            <option value="Upgrade">Upgrade</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="dateFilter">Filter by Date</label>
                        <input type="date" id="dateFilter">
                    </div>
                    <div class="control-group">
                        <label for="searchFilter">Search by Name/Ticket</label>
                        <input type="text" id="searchFilter" placeholder="Search...">
                    </div>
                </div>
                <div class="auto-refresh">
                    <input type="checkbox" id="autoRefresh" checked>
                    <label for="autoRefresh">Auto-refresh every 30 seconds</label>
                    <button class="refresh-btn" onclick="loadAdminQueue()">
                        <i class="fas fa-sync-alt"></i> Refresh Now
                    </button>
                </div>
            </div>

            <div class="admin-table">
                <div class="table-header">
                    <div>Ticket #</div>
                    <div>Customer</div>
                    <div>Service Type</div>
                    <div>Status</div>
                    <div>Date & Time</div>
                    <div>Urgency</div>
                    <div>Contact</div>
                    <div>Actions</div>
                </div>
                <div id="adminTableBody">
                    <!-- Admin table items will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Branch Records Tab -->
        <div id="recordsTab" class="tab-content">
            <div class="admin-controls">
                <div class="control-row">
                    <div class="control-group">
                        <label for="branchFilter">Filter by Branch</label>
                        <select id="branchFilter">
                            <option value="">All Branches</option>
                            <option value="Taguig">Taguig Branch</option>
                            <option value="Silang">Silang Branch</option>
                            <option value="Valenzuela">Valenzuela Branch</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="recordSearchFilter">Search Records</label>
                        <input type="text" id="recordSearchFilter" placeholder="Search by name, ticket, or service type...">
                    </div>
                </div>
                <div class="auto-refresh">
                    <button class="refresh-btn" onclick="loadBranchRecords()">
                        <i class="fas fa-sync-alt"></i> Refresh Records
                    </button>
                </div>
            </div>

            <div id="branchFolders">
                <!-- Branch records will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Ticket Details Modal -->
    <div id="ticketModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ticket Details</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="ticketDetails" class="ticket-details">
                <!-- Ticket details will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Branch Selection Modal -->
    <div id="branchModal" class="branch-modal">
        <div class="branch-modal-content">
            <div class="modal-header">
                <h2>Move to Branch Records</h2>
                <span class="close" onclick="closeBranchModal()">&times;</span>
            </div>
            <form class="branch-form" id="branchForm">
                <div class="control-group">
                    <label for="branchSelect">Select Branch</label>
                    <select id="branchSelect" required>
                        <option value="">Select Branch</option>
                        <option value="Taguig">Taguig Branch</option>
                        <option value="Silang">Silang Branch</option>
                        <option value="Valenzuela">Valenzuela Branch</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="completionNotes">Completion Notes</label>
                    <textarea id="completionNotes" placeholder="Add any additional notes about the completed service..."></textarea>
                </div>
                <div class="branch-buttons">
                    <button type="button" class="btn-cancel" onclick="closeBranchModal()">Cancel</button>
                    <button type="submit" class="btn-save">Save to Branch Records</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let autoRefreshInterval;
        let allTickets = [];
        let currentTicketForBranch = null;

        // Tab functionality
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Load appropriate data
            if (tabName === 'tickets') {
                loadAdminQueue();
            } else if (tabName === 'records') {
                loadBranchRecords();
            }
        }

        // Load admin queue data
        function loadAdminQueue() {
            allTickets = JSON.parse(localStorage.getItem('serviceTickets') || '[]');
            updateAdminStats();
            renderAdminQueue();
        }

        // Load branch records
        function loadBranchRecords() {
            renderBranchFolders();
        }

        // Update admin statistics
        function updateAdminStats() {
            const stats = {
                total: allTickets.length,
                pending: allTickets.filter(t => t.status === 'Pending').length,
                inProgress: allTickets.filter(t => t.status === 'In Progress').length,
                completed: allTickets.filter(t => t.status === 'Completed').length,
                emergency: allTickets.filter(t => t.urgency === 'Emergency').length
            };

            document.getElementById('adminStats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.total}</div>
                    <div class="stat-label">Total Tickets</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.pending}</div>
                    <div class="stat-label">Pending</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.inProgress}</div>
                    <div class="stat-label">In Progress</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.completed}</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.emergency}</div>
                    <div class="stat-label">Emergency</div>
                </div>
            `;
        }

        // Render admin queue table
        function renderAdminQueue() {
            const statusFilter = document.getElementById('statusFilter').value;
            const serviceFilter = document.getElementById('serviceFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();

            let filteredTickets = allTickets.filter(ticket => {
                const matchesStatus = !statusFilter || ticket.status === statusFilter;
                const matchesService = !serviceFilter || ticket.serviceType === serviceFilter;
                const matchesDate = !dateFilter || ticket.preferredDate === dateFilter;
                const matchesSearch = !searchFilter || 
                    ticket.customerName.toLowerCase().includes(searchFilter) ||
                    ticket.ticketNumber.toLowerCase().includes(searchFilter);

                return matchesStatus && matchesService && matchesDate && matchesSearch;
            });

            // Sort by timestamp (newest first)
            filteredTickets.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            const tableBody = document.getElementById('adminTableBody');
            
            if (filteredTickets.length === 0) {
                tableBody.innerHTML = `
                    <div class="no-tickets">
                        <i class="fas fa-inbox"></i>
                        <h3>No tickets found</h3>
                        <p>No service requests match your current filters.</p>
                    </div>
                `;
                return;
            }

            tableBody.innerHTML = filteredTickets.map(ticket => `
                <div class="table-row">
                    <div class="ticket-number">${ticket.ticketNumber}</div>
                    <div class="customer-name">${ticket.customerName}</div>
                    <div class="service-type">${ticket.serviceType}</div>
                    <div class="status-badge status-${ticket.status.toLowerCase().replace(' ', '-')}">${ticket.status}</div>
                    <div class="date-time">
                        <div>${formatDate(ticket.preferredDate)}</div>
                        <div>${ticket.preferredTime}</div>
                    </div>
                    <div class="urgency-${ticket.urgency.toLowerCase()}">${ticket.urgency}</div>
                    <div>${ticket.contactNumber}</div>
                    <div class="action-buttons">
                        <button onclick="viewTicketDetails('${ticket.ticketNumber}')" class="btn-small btn-view">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${ticket.status === 'Pending' ? `
                            <button onclick="updateTicketStatus('${ticket.ticketNumber}', 'In Progress')" class="btn-small btn-progress">
                                <i class="fas fa-play"></i>
                            </button>
                        ` : ''}
                        ${ticket.status === 'In Progress' ? `
                            <button onclick="updateTicketStatus('${ticket.ticketNumber}', 'Completed')" class="btn-small btn-complete">
                                <i class="fas fa-check"></i>
                            </button>
                        ` : ''}
                        ${ticket.status === 'Completed' ? `
                            <button onclick="showBranchModal('${ticket.ticketNumber}')" class="btn-small btn-branch">
                                <i class="fas fa-building"></i>
                            </button>
                        ` : ''}
                        <button onclick="deleteTicket('${ticket.ticketNumber}')" class="btn-small btn-delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Render branch folders
        function renderBranchFolders() {
            const branchFilter = document.getElementById('branchFilter').value;
            const searchFilter = document.getElementById('recordSearchFilter').value.toLowerCase();
            const data = JSON.parse(localStorage.getItem('ashcol_customers') || '[]');
            const branches = ['Taguig', 'Silang', 'Valenzuela'];
            let html = '';
            
            branches.forEach(branch => {
                let branchData = data.filter(r => r.branch === branch);
                
                // Apply filters
                if (branchFilter && branch !== branchFilter) {
                    return; // Skip this branch if filter is applied
                }
                
                branchData = branchData.filter(r => 
                    r.name.toLowerCase().includes(searchFilter) ||
                    r.contact.toLowerCase().includes(searchFilter) ||
                    r.serviceType.toLowerCase().includes(searchFilter) ||
                    r.ticket.toLowerCase().includes(searchFilter)
                );
                
                html += `
                    <details open style="margin-bottom:2rem;">
                        <summary style="font-size:1.2rem;font-weight:600;color:#39B54A;cursor:pointer;">${branch} Branch (${branchData.length})</summary>
                        <table class="customer-table" style="margin-top:1rem;width:100%;border-collapse:collapse;">
                            <thead>
                                <tr style="background:#f8f9fa;">
                                    <th style="padding:0.75rem;text-align:left;border-bottom:2px solid #dee2e6;">Name</th>
                                    <th style="padding:0.75rem;text-align:left;border-bottom:2px solid #dee2e6;">Contact</th>
                                    <th style="padding:0.75rem;text-align:left;border-bottom:2px solid #dee2e6;">Service Type</th>
                                    <th style="padding:0.75rem;text-align:left;border-bottom:2px solid #dee2e6;">Ticket #</th>
                                    <th style="padding:0.75rem;text-align:left;border-bottom:2px solid #dee2e6;">Date</th>
                                    <th style="padding:0.75rem;text-align:left;border-bottom:2px solid #dee2e6;">Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${branchData.length ? branchData.map(r => `
                                    <tr>
                                        <td style="padding:0.75rem;border-bottom:1px solid #dee2e6;">${r.name}</td>
                                        <td style="padding:0.75rem;border-bottom:1px solid #dee2e6;">${r.contact}</td>
                                        <td style="padding:0.75rem;border-bottom:1px solid #dee2e6;">${r.serviceType}</td>
                                        <td style="padding:0.75rem;border-bottom:1px solid #dee2e6;">${r.ticket}</td>
                                        <td style="padding:0.75rem;border-bottom:1px solid #dee2e6;">${r.date}</td>
                                        <td style="padding:0.75rem;border-bottom:1px solid #dee2e6;">${r.notes || ''}</td>
                                    </tr>
                                `).join('') : `<tr><td colspan="6" style="text-align:center;color:#aaa;padding:1rem;">No records found.</td></tr>`}
                            </tbody>
                        </table>
                    </details>
                `;
            });
            
            document.getElementById('branchFolders').innerHTML = html;
        }

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
            });
        }

        // View ticket details in modal
        function viewTicketDetails(ticketNumber) {
            const ticket = allTickets.find(t => t.ticketNumber === ticketNumber);
            if (ticket) {
                document.getElementById('ticketDetails').innerHTML = `
                    <div class="detail-row">
                        <div class="detail-label">Ticket Number:</div>
                        <div class="detail-value">${ticket.ticketNumber}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Customer Name:</div>
                        <div class="detail-value">${ticket.customerName}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Contact Number:</div>
                        <div class="detail-value">${ticket.contactNumber}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Email:</div>
                        <div class="detail-value">${ticket.email || 'N/A'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Service Type:</div>
                        <div class="detail-value">${ticket.serviceType}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Status:</div>
                        <div class="detail-value">${ticket.status}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Preferred Date:</div>
                        <div class="detail-value">${ticket.preferredDate}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Preferred Time:</div>
                        <div class="detail-value">${ticket.preferredTime}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Address:</div>
                        <div class="detail-value">${ticket.address}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Description:</div>
                        <div class="detail-value">${ticket.description}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Urgency:</div>
                        <div class="detail-value">${ticket.urgency}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Created:</div>
                        <div class="detail-value">${new Date(ticket.timestamp).toLocaleString()}</div>
                    </div>
                `;
                document.getElementById('ticketModal').style.display = 'block';
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('ticketModal').style.display = 'none';
        }

        // Show branch modal
        function showBranchModal(ticketNumber) {
            currentTicketForBranch = allTickets.find(t => t.ticketNumber === ticketNumber);
            if (currentTicketForBranch) {
                document.getElementById('branchModal').style.display = 'block';
            }
        }

        // Close branch modal
        function closeBranchModal() {
            document.getElementById('branchModal').style.display = 'none';
            document.getElementById('branchForm').reset();
            currentTicketForBranch = null;
        }

        // Move ticket to branch records
        function moveToBranchRecords(branch, notes) {
            if (!currentTicketForBranch) return;
            
            const record = {
                branch: branch,
                name: currentTicketForBranch.customerName,
                contact: currentTicketForBranch.contactNumber,
                serviceType: currentTicketForBranch.serviceType,
                ticket: currentTicketForBranch.ticketNumber,
                date: new Date().toISOString().split('T')[0],
                notes: notes
            };
            
            // Add to branch records
            const branchData = JSON.parse(localStorage.getItem('ashcol_customers') || '[]');
            branchData.push(record);
            localStorage.setItem('ashcol_customers', JSON.stringify(branchData));
            
            // Remove from active tickets
            allTickets = allTickets.filter(t => t.ticketNumber !== currentTicketForBranch.ticketNumber);
            localStorage.setItem('serviceTickets', JSON.stringify(allTickets));
            
            closeBranchModal();
            loadAdminQueue();
            alert(`Ticket ${currentTicketForBranch.ticketNumber} has been moved to ${branch} Branch records.`);
        }

        // Update ticket status
        function updateTicketStatus(ticketNumber, newStatus) {
            const ticketIndex = allTickets.findIndex(t => t.ticketNumber === ticketNumber);
            if (ticketIndex !== -1) {
                allTickets[ticketIndex].status = newStatus;
                localStorage.setItem('serviceTickets', JSON.stringify(allTickets));
                
                // Send notification to customer (simulated)
                const ticket = allTickets[ticketIndex];
                console.log(`Status update notification sent to ${ticket.contactNumber} for ticket ${ticketNumber}: ${newStatus}`);
                
                loadAdminQueue();
            }
        }

        // Delete ticket
        function deleteTicket(ticketNumber) {
            if (confirm(`Are you sure you want to delete ticket ${ticketNumber}?`)) {
                allTickets = allTickets.filter(t => t.ticketNumber !== ticketNumber);
                localStorage.setItem('serviceTickets', JSON.stringify(allTickets));
                loadAdminQueue();
            }
        }

        // Auto-refresh functionality
        function setupAutoRefresh() {
            const autoRefreshCheckbox = document.getElementById('autoRefresh');
            
            if (autoRefreshCheckbox.checked) {
                autoRefreshInterval = setInterval(loadAdminQueue, 30000); // 30 seconds
            } else {
                clearInterval(autoRefreshInterval);
            }
        }

        // Event listeners
        document.getElementById('statusFilter').addEventListener('change', renderAdminQueue);
        document.getElementById('serviceFilter').addEventListener('change', renderAdminQueue);
        document.getElementById('dateFilter').addEventListener('change', renderAdminQueue);
        document.getElementById('searchFilter').addEventListener('input', renderAdminQueue);
        document.getElementById('autoRefresh').addEventListener('change', setupAutoRefresh);
        document.getElementById('branchFilter').addEventListener('change', renderBranchFolders);
        document.getElementById('recordSearchFilter').addEventListener('input', renderBranchFolders);

        // Branch form submission
        document.getElementById('branchForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const branch = document.getElementById('branchSelect').value;
            const notes = document.getElementById('completionNotes').value;
            
            if (!branch) {
                alert('Please select a branch.');
                return;
            }
            
            moveToBranchRecords(branch, notes);
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('ticketModal');
            const branchModal = document.getElementById('branchModal');
            if (event.target === modal) {
                closeModal();
            }
            if (event.target === branchModal) {
                closeBranchModal();
            }
        }

        // Initialize
        loadAdminQueue();
        setupAutoRefresh();

        // Authentication check
        function checkAuth() {
            const loggedInUser = localStorage.getItem('loggedInUser');
            if (!loggedInUser) {
                alert('Please login to access the admin panel.');
                window.location.href = 'login.html';
                return;
            }
            
            const user = JSON.parse(loggedInUser);
            if (user.role !== 'staff') {
                alert('Access denied. Staff privileges required.');
                window.location.href = 'login.html';
                return;
            }
        }

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', function(e) {
            e.preventDefault();
            localStorage.removeItem('loggedInUser');
            alert('Logged out successfully.');
            window.location.href = 'login.html';
        });

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
        });

        // Clean up interval on page unload
        window.addEventListener('beforeunload', () => {
            clearInterval(autoRefreshInterval);
        });
    </script>
</body>
</html> 